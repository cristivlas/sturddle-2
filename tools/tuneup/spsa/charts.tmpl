<!DOCTYPE html>
<html>
<head>
    <title>Sturddle SPSA Tuner {version}</title>
    <link rel="icon" href="/static/chess.ico">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        :root {{
            --accent-start: #667eea;
            --accent-end: #764ba2;
        }}
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            min-height: 100vh;
            padding: 12px;
            transition: background 1s ease;
        }}
        .container {{
            max-width: 1400px;
            height: calc(100vh - 24px);
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }}
        .header {{
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            color: white;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 1s ease;
        }}
        .header h1 {{
            font-size: 18px;
            font-weight: 700;
        }}
        .header-buttons {{
            display: flex;
            gap: 8px;
        }}
        .status-badge {{
            background: rgba(255,255,255,0.2);
            padding: 6px 16px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            text-decoration: none;
            cursor: pointer;
        }}
        .card-header {{
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }}
        .card-header .caret {{
            font-size: 10px;
            color: #999;
            margin-right: 6px;
            transition: transform 0.2s;
        }}
        .card.collapsed .card-header .caret {{
            transform: rotate(-90deg);
        }}
        .card.collapsed > *:not(.card-header) {{
            display: none;
        }}
        .card.collapsed {{
            flex: 0 0 auto;
        }}
        .card.collapsed h2 {{
            color: #aaa;
        }}
        .content {{
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }}
        .card {{
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 6px 12px;
            background: #f9f9f9;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }}
        .chart-wrap {{
            position: relative;
            flex: 1;
            min-height: 0;
        }}
        .two-col {{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            flex: 1;
            min-height: 0;
        }}
        .sub-card {{
            display: flex;
            flex-direction: column;
            min-height: 0;
        }}
        .sub-card h2 {{
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }}
        .card h2 {{
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }}
        .zoom-bar {{
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }}
        .zoom-track {{
            position: relative;
            flex: 1;
            height: 32px;
        }}
        .zoom-track .bg {{
            position: absolute;
            left: 0; right: 0; top: 50%; height: 4px;
            transform: translateY(-50%);
            background: #ddd;
            border-radius: 2px;
        }}
        .zoom-track .fill {{
            position: absolute;
            top: 50%; height: 4px;
            transform: translateY(-50%);
            background: var(--accent-start, #667eea);
            border-radius: 2px;
        }}
        .zoom-track input[type="range"] {{
            position: absolute;
            left: 0; width: 100%; top: 0; height: 100%;
            margin: 0; padding: 0;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            pointer-events: none;
        }}
        .zoom-track input[type="range"]::-webkit-slider-thumb {{
            -webkit-appearance: none;
            pointer-events: auto;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--accent-start, #667eea);
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }}
        .zoom-track input[type="range"]::-moz-range-track {{
            background: transparent;
            border: 0; height: 0;
        }}
        .zoom-track input[type="range"]::-moz-range-thumb {{
            pointer-events: auto;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: var(--accent-start, #667eea);
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }}
        .zoom-bar span {{
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            min-width: 7em;
        }}
        .refresh-info {{
            padding: 4px 24px;
            font-size: 12px;
            color: #999;
            text-align: center;
            border-top: 1px solid #eee;
        }}
        @media (max-width: 700px), (max-height: 500px) {{
            .header {{ flex-wrap: wrap; gap: 6px; justify-content: center; }}
            .container {{ height: auto; min-height: 100vh; }}
            .two-col {{ grid-template-columns: 1fr; }}
            .card {{ min-height: 200px; }}
            .card.collapsed {{ min-height: 0; }}
            a[href="/logs"] {{ display: none; }}
        }}
    </style>
    <!-- Pre-render collapsed state from localStorage to prevent flicker -->
    <script>
        (function() {{
            try {{
                var saved = JSON.parse(localStorage.getItem('chartVis'));
                if (saved) {{
                    var css = '';
                    for (var k in saved) {{
                        if (!saved[k]) css += '[data-chart="' + k + '"] > *:not(.card-header) {{ display:none }}'
                            + '[data-chart="' + k + '"] {{ flex:0 0 auto }}'
                            + '[data-chart="' + k + '"] h2 {{ color:#aaa }}'
                            + '[data-chart="' + k + '"] .caret {{ transform:rotate(-90deg) }}';
                    }}
                    if (css) {{
                        var s = document.createElement('style');
                        s.id = 'pre-collapse';
                        s.textContent = css;
                        document.head.appendChild(s);
                    }}
                }}
            }} catch(e) {{}}
        }})();
    </script>
    <!-- Time-of-day theme (keep in sync across dashboard/charts/logs templates) -->
    <script>
        function applyTimeTheme() {{
            var h = new Date().getHours();
            var s, e;
            if      (h >= 6  && h < 12) {{ s = '#5ba0b5'; e = '#82c4d8'; }}
            else if (h >= 12 && h < 18) {{ s = '#667eea'; e = '#764ba2'; }}
            else if (h >= 18 && h < 22) {{ s = '#c0766d'; e = '#8e6399'; }}
            else                        {{ s = '#3d4f7c'; e = '#1a1a2e'; }}
            document.documentElement.style.setProperty('--accent-start', s);
            document.documentElement.style.setProperty('--accent-end', e);
        }}
        applyTimeTheme();
        setInterval(applyTimeTheme, 3600000);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sturddle SPSA Tuner {version}</h1>
            <div class="header-buttons">
                <a href="/dashboard" class="status-badge">Dashboard</a>
                <a href="/logs" class="status-badge">Logs</a>
            </div>
        </div>

        <div class="content" id="chartContent">
            <div class="zoom-bar">
                <div class="zoom-track">
                    <div class="bg"></div>
                    <div class="fill" id="zoomFill"></div>
                    <input type="range" id="zoomFrom" min="0" max="1" value="0" oninput="onZoom('from')">
                    <input type="range" id="zoomTo" min="0" max="1" value="1" oninput="onZoom('to')">
                </div>
                <span id="zoomLabel">All</span>
            </div>
            <div class="card" data-chart="params">
                <div class="card-header" onclick="toggleChart('params')"><span class="caret">&#9660;</span><h2>Parameter Values</h2></div>
                <div class="chart-wrap"><canvas id="thetaChart"></canvas></div>
            </div>
            <div class="card" data-chart="elo">
                <div class="card-header" onclick="toggleChart('elo')"><span class="caret">&#9660;</span><h2>ELO Difference</h2></div>
                <div class="chart-wrap"><canvas id="eloChart"></canvas></div>
            </div>
            <div class="card" data-chart="rates">
                <div class="card-header" onclick="toggleChart('rates')"><span class="caret">&#9660;</span><h2>SPSA Coefficients</h2></div>
                <div class="two-col">
                    <div class="sub-card">
                        <h2>Learning Rate (a_k)</h2>
                        <div class="chart-wrap"><canvas id="akChart"></canvas></div>
                    </div>
                    <div class="sub-card">
                        <h2>Perturbation Size (c_k)</h2>
                        <div class="chart-wrap"><canvas id="ckChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="refresh-info">
            Generated at {timestamp}
        </div>
    </div>

    <script>
        var chartKeys = ['params', 'elo', 'rates'];
        var chartVis = {{ params: true, elo: true, rates: true }};
        try {{
            var saved = JSON.parse(localStorage.getItem('chartVis'));
            if (saved) {{
                for (var k in saved) if (k in chartVis) chartVis[k] = saved[k];
                if (!Object.values(chartVis).some(Boolean)) chartVis.params = true;
            }}
        }} catch(e) {{}}

        // Dual-slider zoom: control x-axis window across all charts
        var _labels = [];
        function onZoom(src) {{
            var f = document.getElementById('zoomFrom');
            var t = document.getElementById('zoomTo');
            // Prevent thumbs from crossing
            if (src === 'from' && +f.value > +t.value) f.value = t.value;
            if (src === 'to'   && +t.value < +f.value) t.value = f.value;
            applyZoomRange(+f.value, +t.value);
        }}
        function applyZoomRange(from, to) {{
            var last = _labels.length - 1;
            var minVal = from > 0    ? _labels[from] : undefined;
            var maxVal = to   < last ? _labels[to]   : undefined;
            // Active charts
            document.querySelectorAll('canvas').forEach(function(c) {{
                var ch = typeof Chart !== 'undefined' && Chart.getChart && Chart.getChart(c);
                if (!ch) return;
                if (!ch.options.scales) ch.options.scales = {{}};
                if (!ch.options.scales.x) ch.options.scales.x = {{}};
                if (minVal !== undefined) ch.options.scales.x.min = minVal;
                else delete ch.options.scales.x.min;
                if (maxVal !== undefined) ch.options.scales.x.max = maxVal;
                else delete ch.options.scales.x.max;
                ch.update('none');
            }});
            // Pending chart configs
            for (var id in _pending) {{
                var o = _pending[id].options;
                if (!o.scales) o.scales = {{}};
                if (!o.scales.x) o.scales.x = {{}};
                if (minVal !== undefined) o.scales.x.min = minVal;
                else delete o.scales.x.min;
                if (maxVal !== undefined) o.scales.x.max = maxVal;
                else delete o.scales.x.max;
            }}
            // Fill bar
            var span = last || 1;
            var fill = document.getElementById('zoomFill');
            if (fill) {{
                fill.style.left  = (from / span * 100) + '%';
                fill.style.right = ((1 - to / span) * 100) + '%';
            }}
            // Label
            var lbl = document.getElementById('zoomLabel');
            if (lbl) lbl.textContent = (minVal !== undefined || maxVal !== undefined)
                ? (_labels[from] || _labels[0]) + ' \u2013 ' + (_labels[to] || _labels[last])
                : 'All';
            // Persist
            try {{ localStorage.setItem('chartZoom', JSON.stringify({{f:from, t:to}})); }} catch(e) {{}}
        }}

        // Deferred chart creation for canvases hidden at init time
        var _pending = {{}};
        var _canvasCard = {{ thetaChart:'params', eloChart:'elo', akChart:'rates', ckChart:'rates' }};
        function createPending() {{
            for (var id in _pending) {{
                var el = document.getElementById(id);
                if (!el) continue;
                if (typeof Chart !== 'undefined' && Chart.getChart && Chart.getChart(el)) continue;
                var card = el.closest('[data-chart]');
                if (card && !card.classList.contains('collapsed')) {{
                    new Chart(el.getContext('2d'), _pending[id]);
                    delete _pending[id];
                }}
            }}
        }}

        function applyVis() {{
            document.querySelectorAll('[data-chart]').forEach(function(card) {{
                var key = card.getAttribute('data-chart');
                card.classList.toggle('collapsed', !chartVis[key]);
            }});
            var pre = document.getElementById('pre-collapse');
            if (pre) pre.remove();
            localStorage.setItem('chartVis', JSON.stringify(chartVis));
            requestAnimationFrame(createPending);
        }}

        function toggleChart(key) {{
            chartVis[key] = !chartVis[key];
            // If all off, cycle to the next chart
            if (!Object.values(chartVis).some(Boolean)) {{
                var next = chartKeys[(chartKeys.indexOf(key) + 1) % chartKeys.length];
                chartVis[next] = true;
            }}
            applyVis();
        }}

        document.addEventListener('DOMContentLoaded', applyVis);
    </script>

    <script>{chart_js}</script>
    <script id="history-data" type="application/json">{history_json}</script>
    <script>
        (function() {{
            try {{
                const raw = document.getElementById('history-data').textContent || '[]';
                const history = JSON.parse(raw || '[]') || [];
                if (!history || !history.length) return;

                history.sort((a,b) => (a.iteration||0) - (b.iteration||0));
                const labels = history.map(h => h.iteration);
                _labels = labels;
                var sMax = labels.length - 1;
                var sf = document.getElementById('zoomFrom');
                var st = document.getElementById('zoomTo');
                if (sf) {{ sf.max = sMax; }}
                if (st) {{ st.max = sMax; st.value = sMax; }}
                var _restoredZoom = null;
                try {{
                    var sz = JSON.parse(localStorage.getItem('chartZoom'));
                    if (sz) {{
                        var zf = Math.max(0, Math.min(sz.f || 0, sMax));
                        var zt = Math.max(zf, Math.min(sz.t != null ? sz.t : sMax, sMax));
                        if (sf) sf.value = zf;
                        if (st) st.value = zt;
                        if (zf > 0 || zt < sMax) _restoredZoom = [zf, zt];
                    }}
                }} catch(e) {{}}
                const defaultOpts = {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{ legend: {{ position: 'bottom' }} }}
                }};

                // Create chart now if visible, otherwise stash for deferred creation
                function initChart(canvasId, config) {{
                    var cardKey = _canvasCard[canvasId];
                    if (cardKey && !chartVis[cardKey]) {{
                        _pending[canvasId] = config;
                    }} else {{
                        new Chart(document.getElementById(canvasId).getContext('2d'), config);
                    }}
                }}

                function makeChart(canvasId, data, label, color) {{
                    initChart(canvasId, {{
                        type: 'line',
                        data: {{
                            labels: labels,
                            datasets: [{{
                                label: label,
                                data: data,
                                borderColor: color,
                                backgroundColor: color + '20',
                                tension: 0.25,
                                pointRadius: 1,
                                borderWidth: 2,
                                fill: true
                            }}]
                        }},
                        options: defaultOpts
                    }});
                }}

                // Parameter values (multi-series)
                const thetaKeys = [...new Set(
                    history.flatMap(h => Object.keys(h.theta || {{}}))
                )];
                const thetaDatasets = thetaKeys.map(k => ({{
                    label: k,
                    data: history.map(h => (h.theta && k in h.theta) ? h.theta[k] : null),
                    tension: 0.25,
                    pointRadius: 1,
                    borderWidth: 2,
                }}));
                initChart('thetaChart', {{
                    type: 'line',
                    data: {{ labels: labels, datasets: thetaDatasets }},
                    options: defaultOpts
                }});

                makeChart('eloChart', history.map(h => h.elo_diff), 'ELO Diff', '#e91e63');
                makeChart('akChart', history.map(h => h.a_k), 'a_k', '#2196F3');
                makeChart('ckChart', history.map(h => h.c_k), 'c_k', '#FF9800');

                // Apply saved zoom now that charts and _pending are populated
                if (_restoredZoom) applyZoomRange(_restoredZoom[0], _restoredZoom[1]);
            }} catch (e) {{
                console.error('Failed to render charts', e);
            }}
        }})();
    </script>
</body>
</html>
