# Makefile for standalone executable

CC = clang-18
CXX = clang++-18

SOURCES = chess.cpp context.cpp search.cpp uci_native.cpp main.cpp

# Object files
OBJECTS = $(SOURCES:.cpp=.o)

DEPS = $(OBJECTS:.o=.d)

# Target executable
TARGET = sturddle-2.3

# Include directories
INCLUDES = -I./libpopcnt -I./magic-bits/include -I./version2 -I/usr/include/python3.11

# Build timestamp
BUILD_STAMP = $(shell date +%m%d%y)

# MemorySanitizer-specific flags
MSAN_FLAGS = \
        -fsanitize=memory \
        -fsanitize-memory-track-origins=2 \
        -fno-omit-frame-pointer \
        -fsanitize-ignorelist=$(shell pwd)/msan_ignore.txt

CXXFLAGS = -MMD -MP \
        $(MSAN_FLAGS) \
        $(INCLUDES) \
        -O1 \
        -gdwarf-4 \
        -std=c++20 \
        -stdlib=libc++ \
        -fexperimental-library \
        -DNO_ASSERT \
        -D_DEBUG \
        -D_FORTIFY_SOURCE=0 \
        -DSTANDALONE \
        -DBUILD_STAMP=$(BUILD_STAMP) \
        -DCALLBACK_PERIOD=8192 \
        -DWITH_NNUE \
        -DNATIVE_UCI=true \
        -DUSE_MAGIC_BITS=false \
        -fno-stack-protector \
        -Wextra \
        -Wno-unused-parameter \
        -march=native

#. Linker flags
LDFLAGS = \
        $(MSAN_FLAGS) \
        -fuse-ld=lld \
        -L/usr/lib/llvm-18/lib/ \
        -L/usr/lib/llvm-18/lib/x86_64-pc-linux-gnu \
        -lc++ \
        -lc++experimental


# Default target
all: $(TARGET)

# Build object files
%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Link executable
$(TARGET): $(OBJECTS)
	$(CXX) $(LDFLAGS) $(OBJECTS) -o $(TARGET)

# Clean build files
clean:
	rm -f $(OBJECTS) $(TARGET) $(DEPS)

# Print variables for debugging
debug:
	@echo "CC: $(CC)"
	@echo "CXX: $(CXX)"
	@echo "SOURCES: $(SOURCES)"
	@echo "OBJECTS: $(OBJECTS)"
	@echo "CXXFLAGS: $(CXXFLAGS)"
	@echo "LDFLAGS: $(LDFLAGS)"

.PHONY: all run clean debug

-include $(DEPS)
